<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Downloading daily stock data</h1><p class="page-description">Getting the data!</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-06-28T00:00:00-05:00" itemprop="datePublished">
        Jun 28, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#finance">finance</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#data">data</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-06-28-Data-Retrieval.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>My ambition is to build a fully automated trading system that:</p>
<ul>
<li>Downloads the latest data</li>
<li>Performs some cleaning steps</li>
<li>Generates trading signals</li>
<li>Opens and closes positions in accordance with a risk management framework</li>
</ul>
<p>This system will be built step by step in a series of posts. As the list suggests, the first step is to update the database with the latest data when it is available. First, what database are we using?</p>
<h2 id="Database">Database<a class="anchor-link" href="#Database"> </a></h2><p>There are many options when it comes to chosing a database. The most popular type of database for tabular data is a SQL database. This is due to their good performance and data structure. SQL databases are structured in a tabular fasion which is the same structure that pandas dataframes are structured. Noteworthy SQL databases are MariaDB, PostgreSQL and SQLite. However, a SQL database will not be used in this project for a number of reasons. Instead, a NOSQL database will be used. More specifically, <a href="https://en.wikipedia.org/wiki/MongoDB">MongoDB</a>. But, why? First let's address the pros and cons of SQL databases. It is true that they usually have good performance. This can be a deciding factor, but for small amounts of data (&lt;50GB) there might not be any difference. NOSQL databases can be just as performant if queried correctly and if indicies are used. When it comes to the data structure, some restructuring of the data has to be performed before it can be inserted into a NOSQL database. But this is not a problem, many python libraries have functions such as <code>dataframe.to_dict("records")</code> that easily converts tabular data into a list of dictionaries suited for NOSQL databases. These arguments cancel eachother out, and either database type could be used. The final con of SQL databases that tips the needle in favor of NOSQL databases is that the python libraries that are used to access SQL databases have terrible APIs. Not only that, setting up such a database is also a painful process that takes a lot of time if it is to be done right.</p>
<h2 id="Imports-and-connections">Imports and connections<a class="anchor-link" href="#Imports-and-connections"> </a></h2><p>Now for the program used to download the data. The following imports and connections are going to be needed.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pymongo</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">borsdata_api</span> <span class="k">as</span> <span class="nn">api</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">BorsdataAPI</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;api.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>  <span class="c1"># Börsdata is used as data source</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="s1">&#39;192.168.1.38&#39;</span><span class="p">,</span> <span class="mi">27017</span><span class="p">)</span> <span class="c1"># MongoDB server connection</span>
<span class="n">daily</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">prod</span><span class="o">.</span><span class="n">daily</span>                           <span class="c1"># The collection used to store daily data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Defining-aggregation-query-and-getting-the-symbols">Defining aggregation query and getting the symbols<a class="anchor-link" href="#Defining-aggregation-query-and-getting-the-symbols"> </a></h2><p>It is important not to add duplicate data to the database. This can be solved by quering the database for all the dates that are already present in the database and then ignore these dates when adding the new data. This can be done with the following MongoDB aggregation query. It essencially matches the wanted stock symbol and then creates a list with all the dates.<br /><br />
This cell also contains the query for all the stock symbols. These are stored in a separate collection called <code>stock_info</code>. The list of symbols returned will be used to tell the API what stocks to download.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">aggreg_query</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;$match&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="s1">&#39;$group&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="s1">&#39;$symbol&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$push&#39;</span><span class="p">:</span> <span class="s1">&#39;$date&#39;</span><span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
<span class="n">symbols</span> <span class="o">=</span> <span class="p">[(</span><span class="n">stock</span><span class="p">[</span><span class="s2">&quot;yahoo&quot;</span><span class="p">],</span> <span class="n">stock</span><span class="p">[</span><span class="s2">&quot;insId&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">prod</span><span class="o">.</span><span class="n">stock_info</span><span class="o">.</span><span class="n">find</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of symbols:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Number of symbols: 1780
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Download-loop">Download loop<a class="anchor-link" href="#Download-loop"> </a></h2><p>This is where the magic happens. This for-loop loops through the list of symbols previously retrieved and performs these steps:</p>
<ul>
<li>Downloads the data.</li>
<li>Removes rows with NaN values.</li>
<li>Detaches the index (dates) and adds it as a column.</li>
<li>Makes all the column names lowercase.</li>
<li>Adds the symbol to every row. This is an important field for when every row becomes a document.</li>
<li>Adds the date and time when the data was retrieved.</li>
<li>Adds a string as the primary key. This a second security measure to prevents the adding of the same date twice to the database.</li>
<li>Removes the already present rows from the data we are going to add to the database. This uses the abovementioned aggregation query.</li>
<li>Finally, it converts the tabular data to documents (dictionaries) and inserts them into the database.</li>
</ul>
<p>This loop may take a long time to finish. Especially when the number of stocks is large. Some APIs might stop giving you data by blocking your requests a long time before all the symbols have been looped through. This is one of the reasons by <a href="https://borsdata.se/">Börsdata</a> is used. Although it is a payed service, it does not limit the number of requests. If this is not an option for you, YahooFinance's API can be used. The pros are that they have all the stocks you could ever want and are free, but they start blocking requests after a couple of hundred queries.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">progress</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
<span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">insId</span> <span class="ow">in</span> <span class="n">progress</span><span class="p">:</span>
    <span class="n">progress</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="c1"># Set progress bar description</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_instrument_stock_prices</span><span class="p">(</span><span class="n">insId</span><span class="p">)</span> <span class="c1"># Download the data</span>
    <span class="c1">#df = data[symbol]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="n">aggreg_query</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;$match&quot;</span><span class="p">][</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">daily</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">aggreg_query</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># Check if stock already in db</span>
        <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span> <span class="c1"># Ignoring indicies already in db</span>
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">daily</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Cronjob">Cronjob<a class="anchor-link" href="#Cronjob"> </a></h2><p>To make the data retrieval automatic it has to be scheduled. This can easily be done using cronjob on linux machines. The following script will be made into a <a href="https://en.wikipedia.org/wiki/Cron">cronjob</a> and this parameter will be added to the crontab <code>0 18 * * 1-5 data_downloader/daily_downloader.py</code>. The parameter means that the command should be run every weekday at 18 o'clock.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="c1">#----------------------------------------------------------------------------</span>

<span class="c1">#!data_downloader/env/bin/python</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pymongo</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">borsdata_api</span> <span class="k">as</span> <span class="nn">api</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">BorsdataAPI</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;api.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>  <span class="c1"># Börsdata is used as data source</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="s1">&#39;192.168.1.38&#39;</span><span class="p">,</span> <span class="mi">27017</span><span class="p">)</span> <span class="c1"># MongoDB server connection</span>
<span class="n">daily</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">prod</span><span class="o">.</span><span class="n">daily</span>                           <span class="c1"># The collection used to store daily data</span>

<span class="n">aggreg_query</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;$match&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="s1">&#39;$group&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="s1">&#39;$symbol&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$push&#39;</span><span class="p">:</span> <span class="s1">&#39;$date&#39;</span><span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>

<span class="n">symbols</span> <span class="o">=</span> <span class="p">[(</span><span class="n">stock</span><span class="p">[</span><span class="s2">&quot;yahoo&quot;</span><span class="p">],</span> <span class="n">stock</span><span class="p">[</span><span class="s2">&quot;insId&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">prod</span><span class="o">.</span><span class="n">stock_info</span><span class="o">.</span><span class="n">find</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of symbols:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">))</span>
<span class="n">progress</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
<span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">insId</span> <span class="ow">in</span> <span class="n">progress</span><span class="p">:</span>
    <span class="n">progress</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="c1"># Set progress bar description</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_instrument_stock_prices</span><span class="p">(</span><span class="n">insId</span><span class="p">)</span> <span class="c1"># Download the data</span>
    <span class="c1">#df = data[symbol]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="n">aggreg_query</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;$match&quot;</span><span class="p">][</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">daily</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">aggreg_query</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># Check if stock already in db</span>
        <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span> <span class="c1"># Ignoring indicies already in db</span>
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">daily</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/finance/data/2021/06/28/Data-Retrieval.html" hidden></a>
</article>